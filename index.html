@
<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–í–∏–¥–µ–æ: 1‚Äì28 ‚Ä¢ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω + —É–º–Ω—ã–π —Ç–∞–π–º–µ—Ä</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0f1222;
      --panel: #171a2e;
      --muted: #8d93b5;
      --text: #e7e9ff;
      --acc: #6c7bff;
      --acc2: #4ce0b3;
      --danger: #ff6b6b;
      --ok: #48d28d;
      --warn: #ffcc66;
      --radius: 14px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, #1b1f3b 0%, #0f1222 55%) fixed;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(180deg, rgba(15, 18, 34, .95), rgba(15, 18, 34, .75));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #262a4a;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px;
    }

    .nav {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .nav h1 {
      font-size: 18px;
      margin: 0 10px 0 0;
      color: #cfd3ff
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .tab-btn {
      border: 1px solid #2a2f55;
      background: #151936;
      color: #cfd3ff;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer
    }

    .tab-btn.active {
      background: linear-gradient(180deg, #2a2f55, #202552);
      border-color: #3b4180
    }

    main .wrap {
      padding-top: 16px
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, 1fr);
    }

    .card {
      grid-column: span 12;
      background: linear-gradient(180deg, #151936, #11142b);
      border: 1px solid #262a4a;
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, .25), inset 0 1px 0 rgba(255, 255, 255, .02)
    }

    .card h2 {
      margin: .1rem 0 .6rem;
      font-size: 18px
    }

    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center
    }

    .grow {
      flex: 1
    }

    .muted {
      color: var(--muted)
    }

    .kpi {
      display: flex;
      gap: 14px;
      flex-wrap: wrap
    }

    .kpi .pill {
      background: #131733;
      border: 1px solid #2a2f55;
      border-radius: 12px;
      padding: 10px 12px;
      min-width: 140px
    }

    input[type="number"],
    input[type="text"],
    input[type="month"] {
      background: #0f1330;
      border: 1px solid #2a2f55;
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      min-width: 110px;
    }

    button {
      background: linear-gradient(180deg, #6c7bff, #4f5efc);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: .15s transform ease;
      box-shadow: 0 6px 20px rgba(108, 123, 255, .25)
    }

    button:active {
      transform: translateY(1px)
    }

    button.ghost {
      background: #14183a;
      border: 1px solid #2a2f55;
      box-shadow: none;
      color: #cbd0ff
    }

    button.warn {
      background: linear-gradient(180deg, #ff9b4d, #ff7a3d);
      box-shadow: 0 6px 20px rgba(255, 154, 77, .25)
    }

    button.danger {
      background: linear-gradient(180deg, #ff6b6b, #ff4d4d);
      box-shadow: 0 6px 20px rgba(255, 107, 107, .25)
    }

    .progress {
      height: 14px;
      width: 100%;
      background: #0f1330;
      border: 1px solid #2a2f55;
      border-radius: 999px;
      overflow: hidden
    }

    .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--acc), var(--acc2));
      transition: width .4s ease
    }

    .stat {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center
    }

    .stat .big {
      font-size: 32px;
      font-weight: 700
    }

    .timer {
      display: flex;
      align-items: center;
      gap: 10px;
      font-variant-numeric: tabular-nums;
      padding: 12px 14px;
      background: #0f1330;
      border: 1px solid #2a2f55;
      border-radius: 12px
    }

    .timer .time {
      font-size: 28px;
      min-width: 140px;
      text-align: center
    }

    .badge {
      padding: 6px 10px;
      background: #122046;
      border: 1px solid #2a2f55;
      border-radius: 999px;
      font-size: 12px;
      color: #cfd3ff
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px
    }

    thead th {
      font-weight: 600;
      text-align: left;
      color: #b8bef5;
      font-size: 13px;
      padding: 0 10px
    }

    tbody tr {
      background: #121635;
      border: 1px solid #262a4a
    }

    tbody tr td {
      padding: 12px 10px
    }

    tbody tr td:first-child {
      border-radius: 10px 0 0 10px
    }

    tbody tr td:last-child {
      border-radius: 0 10px 10px 0
    }

    .status {
      font-weight: 700
    }

    .ok {
      color: var(--ok)
    }

    .warnc {
      color: var(--warn)
    }

    .bad {
      color: var(--danger)
    }

    .right {
      text-align: right
    }

    .sep {
      height: 1px;
      background: #262a4a;
      margin: 10px 0
    }

    .quote {
      font-style: italic;
      color: #cfd3ff;
      opacity: .9
    }

    .footer-note {
      color: #98a0d8;
      font-size: 12px
    }

    .mini {
      font-size: 12px;
      color: #b8bef5
    }

    .mono {
      font-variant-numeric: tabular-nums
    }

    @media (min-width:860px) {
      .span-6 {
        grid-column: span 6
      }

      .span-4 {
        grid-column: span 4
      }

      .span-8 {
        grid-column: span 8
      }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap nav">
      <h1>–í–∏–¥–µ–æ: 1‚Äì28 ‚Ä¢ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω</h1>
      <div class="tabs">
        <button class="tab-btn active" data-tab="focus">–§–æ–∫—É—Å & –¢–∞–π–º–µ—Ä</button>
        <button class="tab-btn" data-tab="plan">–ü–ª–∞–Ω 1‚Äì28</button>
      </div>
      <div class="grow"></div>
      <span class="badge" id="streakBadge">üî• –°—Ç–∏–∫: 0</span>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- TAB: Focus -->
      <section id="tab-focus" class="grid">
        <div class="card span-8">
          <h2>–¢–∞–π–º–µ—Ä —Ä–∞–±–æ—Ç—ã</h2>
          <div class="row">
            <div class="timer">
              <span class="time mono" id="timeDisplay">00:00:00</span>
              <button id="startBtn">–°—Ç–∞—Ä—Ç</button>
              <button id="pauseBtn" class="ghost">–ü–∞—É–∑–∞</button>
              <button id="finishVideoBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–µ–º—è –Ω–∞ –≤–∏–¥–µ–æ –∏ –∑–∞—á–µ—Å—Ç—å +1">–ì–æ—Ç–æ–≤–æ (+1 –≤–∏–¥–µ–æ)</button>
              <button id="resetBtn" class="warn">–°–±—Ä–æ—Å</button>
            </div>
            <div class="kpi">
              <div class="pill">
                <div class="muted">–°–µ—Å—Å–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                <div class="stat"><span id="sessionsDone" class="big">0</span><span class="muted">—à—Ç</span></div>
              </div>
              <div class="pill">
                <div class="muted">–í–∏–¥–µ–æ —Å–µ–≥–æ–¥–Ω—è</div>
                <div class="stat"><span id="videosToday" class="big">0</span><span class="muted">—à—Ç</span></div>
              </div>
              <div class="pill">
                <div class="muted">–í—Ä–µ–º—è –∑–∞ –¥–µ–Ω—å</div>
                <div class="stat"><span id="minutesToday" class="big">0</span><span class="muted">–º–∏–Ω</span></div>
              </div>
            </div>
          </div>
          <div class="sep"></div>
          <div class="row">
            <div class="grow">
              <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω)</div>
              <div class="progress">
                <div id="dayBar" class="bar"></div>
              </div>
              <div class="row" style="margin-top:8px">
                <span>–°–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ: <b id="videosTodayInline">0</b> –∏–∑ <b id="dailyGoalLabel">0</b></span>
                <div class="grow"></div>
                <button id="plus1" class="ghost" title="–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ –±–µ–∑ —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏">+1 –≤–∏–¥–µ–æ</button>
                <button id="minus1" class="ghost">‚àí1</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card span-4">
          <h2>–¢–∞–π–º–∏–Ω–≥ –≤–∏–¥–µ–æ (—Å–µ–≥–æ–¥–Ω—è)</h2>
          <div class="kpi">
            <div class="pill">
              <div class="muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –≤–∏–¥–µ–æ</div>
              <div class="stat"><span id="lastVideoMin" class="big">‚Äî</span><span class="muted">–º–∏–Ω</span></div>
            </div>
            <div class="pill">
              <div class="muted">–°—Ä–µ–¥–Ω–µ–µ</div>
              <div class="stat"><span id="avgVideoMin" class="big">‚Äî</span><span class="muted">–º–∏–Ω</span></div>
            </div>
            <div class="pill">
              <div class="muted">–õ—É—á—à–µ–µ / —Ö—É–¥—à–µ–µ</div>
              <div class="stat"><span id="bestWorst" class="big">‚Äî</span><span class="muted">–º–∏–Ω</span></div>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="pill">
              <div class="muted">–í–∏–¥–µ–æ-–º–∏–Ω—É—Ç –∑–∞ –¥–µ–Ω—å</div>
              <div class="stat"><span id="videoMinutesToday" class="big">0</span><span class="muted">–º–∏–Ω</span></div>
            </div>
            <div class="pill">
              <div class="muted">–ú–∏–Ω/–≤–∏–¥–µ–æ ‚Üî VPH</div>
              <div class="stat"><span id="efficiency" class="big">‚Äî</span><span class="muted"></span></div>
            </div>
          </div>
          <p class="mini" id="targetVideoHint">–¶–µ–ª—å: <b id="targetVideoMinLabel">10</b> –º–∏–Ω/–≤–∏–¥–µ–æ (<span
              id="deltaLabel">‚Äî</span>)</p>
          <div class="sep"></div>
          <p class="footer-note">–ö–Ω–æ–ø–∫–∞ ¬´–ì–æ—Ç–æ–≤–æ (+1 –≤–∏–¥–µ–æ)¬ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Ä–µ–º—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞ –∏ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π
            –æ—Ç—Å—á—ë—Ç.</p>
        </div>

        <div class="card span-6">
          <h2>–°–≤–æ–¥–∫–∞ –ø–µ—Ä–∏–æ–¥–∞ (1‚Äì28)</h2>
          <div class="kpi">
            <div class="pill">
              <div class="muted">–¶–µ–ª—å –Ω–∞ –ø–µ—Ä–∏–æ–¥</div>
              <div class="stat"><span id="planTotal" class="big">270</span><span class="muted">–≤–∏–¥–µ–æ</span></div>
            </div>
            <div class="pill">
              <div class="muted">–ì–æ—Ç–æ–≤–æ</div>
              <div class="stat"><span id="doneTotal" class="big">0</span><span class="muted">–≤–∏–¥–µ–æ</span></div>
            </div>
            <div class="pill">
              <div class="muted">–û—Å—Ç–∞–ª–æ—Å—å –¥–æ —Ü–µ–ª–∏</div>
              <div class="stat"><span id="leftTotal" class="big">270</span><span class="muted">–≤–∏–¥–µ–æ</span></div>
            </div>
            <div class="pill">
              <div class="muted">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
              <div class="stat"><span id="progressPct" class="big">0%</span><span class="muted"></span></div>
            </div>
          </div>
        </div>

        <div class="card span-6">
          <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <div class="row">
            <label>–ú–µ—Å—è—Ü:
              <input type="month" id="monthInput">
            </label>
            <label>–î–Ω–µ–≤–Ω–æ–π –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω:
              <input type="number" id="dailyGoalInput" min="0" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 10">
            </label>
            <label>–¶–µ–ª—å –Ω–∞ –ø–µ—Ä–∏–æ–¥ (‚â•270):
              <input type="number" id="targetTotalInput" min="270" step="1" placeholder="–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 270">
            </label>
            <label>–¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –Ω–∞ –≤–∏–¥–µ–æ (–º–∏–Ω):
              <input type="number" id="targetVideoMinInput" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 10">
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="autoAdaptInput" checked> –ê–≤—Ç–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–∞</label>
          </div>
          <div class="row" style="margin-top:10px">
            <button id="applySettings">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button id="recalcNow" class="ghost">–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω —Å–µ–π—á–∞—Å</button>
            <button id="resetAll" class="danger">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
            <div class="grow"></div>
            <button id="exportBtn" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <input type="file" id="importFile" accept="application/json" style="display:none">
            <button id="importBtn" class="ghost">–ò–º–ø–æ—Ä—Ç JSON</button>
          </div>
          <p class="footer-note">–ü–ª–∞–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π, —á—Ç–æ–±—ã –≤—ã–π—Ç–∏ –Ω–∞ —Ü–µ–ª—å –ø–µ—Ä–∏–æ–¥–∞.
            –ü–µ—Ä–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Äî –æ–∫ üëç</p>
        </div>

        <div class="card span-12">
          <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
          <div style="height:250px; width:100%"><canvas id="prodChart"></canvas></div>
        </div>
      </section>

      <!-- TAB: Plan -->
      <section id="tab-plan" class="grid" style="display:none">
        <div class="card">
          <h2>–ü–ª–∞–Ω 1‚Äì28 ‚Ä¢ <span id="periodLabel">‚Äî</span></h2>
          <div class="row">
            <div class="muted">–î–∞—Ç—ã: <span id="periodRange">‚Äî</span></div>
            <div class="grow"></div>
            <span class="mini">–¶–µ–ª—å –ø–µ—Ä–∏–æ–¥–∞: <b id="goalInline">270</b></span>
            <button id="prevMonth" class="ghost">‚Üê –ü—Ä–µ–¥. –º–µ—Å—è—Ü</button>
            <button id="nextMonth" class="ghost">–°–ª–µ–¥. –º–µ—Å—è—Ü ‚Üí</button>
            <button id="autoDistribute" class="ghost"
              title="–†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –æ—Å—Ç–∞–≤—à–∏–º—Å—è –¥–Ω—è–º">–ê–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å</button>
          </div>
          <div class="sep"></div>
          <div style="overflow:auto">
            <table id="planTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>–î–∞—Ç–∞</th>
                  <th>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</th>
                  <th class="right">–ü–ª–∞–Ω</th>
                  <th class="right">–í—ã–ª–æ–∂–µ–Ω–æ</th>
                  <th class="right">–û—Å—Ç–∞–ª–æ—Å—å</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
              </thead>
              <tbody><!-- rows injected --></tbody>
              <tfoot>
                <tr>
                  <td></td>
                  <td></td>
                  <td class="right"><b>–ò–¢–û–ì–û:</b></td>
                  <td class="right" id="tPlan">0</td>
                  <td class="right" id="tDone">0</td>
                  <td class="right" id="tLeft">0</td>
                  <td id="tStatus">‚Äî</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <canvas id="confetti"
    style="position:fixed; inset:0; pointer-events:none; opacity:0; transition:opacity .4s ease"></canvas>

  <script>
    /* ======== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã / —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ======== */
    const KEY_V2 = 'video28.month.v2';
    const KEY_V1 = 'video28.month.v1'; // –º–∏–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏
    const RU_DAYS_FULL = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞'];

    const state = loadState();
    let timerInt = null, startTs = null;

    /* ======== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –∑–∞–≥—Ä—É–∑–∫–∞ ======== */
    function defaultState() {
      const now = new Date();
      const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      return {
        periodYM: ym,           // YYYY-MM
        dailyGoal: 10,          // –±–∞–∑–æ–≤—ã–π –ø–ª–∞–Ω –Ω–∞ –¥–µ–Ω—å
        targetTotal: 270,       // —Ü–µ–ª—å –ø–µ—Ä–∏–æ–¥–∞ (–º–æ–∂–Ω–æ >270)
        targetVideoMin: 10,     // —Ü–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –Ω–∞ –≤–∏–¥–µ–æ, –º–∏–Ω
        autoAdapt: true,        // –∞–≤—Ç–æ-–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–∞
        sessionsDone: 0,
        minutesByDate: {},      // {'YYYY-MM-DD': minutes} ‚Äî –æ–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã
        videosByDate: {},       // {'YYYY-MM-DD': count}
        planByDate: {},         // {'YYYY-MM-DD': planned}
        videoDurationsByDate: {}// {'YYYY-MM-DD': [min, min, ...]} ‚Äî –≤—Ä–µ–º—è –Ω–∞ –∫–∞–∂–¥–æ–µ –≤–∏–¥–µ–æ
      };
    }
    function loadState() {
      // v2
      const v2raw = localStorage.getItem(KEY_V2);
      if (v2raw) {
        try { return JSON.parse(v2raw); } catch (e) { }
      }
      // –º–∏–≥—Ä–∞—Ü–∏—è —Å v1 (–µ—Å–ª–∏ –µ—Å—Ç—å)
      const v1raw = localStorage.getItem(KEY_V1);
      if (v1raw) {
        try {
          const old = JSON.parse(v1raw);
          const fresh = defaultState();
          fresh.periodYM = old.periodYM || fresh.periodYM;
          fresh.dailyGoal = old.dailyGoal ?? fresh.dailyGoal;
          fresh.sessionsDone = old.sessionsDone || 0;
          fresh.minutesByDate = old.minutesByDate || {};
          fresh.videosByDate = old.videosByDate || {};
          fresh.planByDate = old.planByDate || {};
          save(fresh);
          return fresh;
        } catch (e) { }
      }
      const d = defaultState(); save(d); return d;
    }
    function save(s = state) { localStorage.setItem(KEY_V2, JSON.stringify(s)); }

    /* ======== –£—Ç–∏–ª–∏—Ç—ã –¥–∞—Ç ======== */
    function ymToDates(ym) { // 1..28 —á–∏—Å–ª–∞ –º–µ—Å—è—Ü–∞
      const [y, m] = ym.split('-').map(Number);
      const res = [];
      for (let d = 1; d <= 28; d++) { const dt = new Date(y, m - 1, d); res.push(dt.toISOString().slice(0, 10)); }
      return res;
    }
    function addMonthsYM(ym, delta) {
      let [y, m] = ym.split('-').map(Number);
      m += delta;
      while (m < 1) { m += 12; y--; }
      while (m > 12) { m -= 12; y++; }
      return `${y}-${String(m).padStart(2, '0')}`;
    }
    function todayStr() {
      const d = new Date();
      const offset = d.getTimezoneOffset() * 60000;
      return new Date(d.getTime() - offset).toISOString().slice(0, 10);
    }

    /* ======== DOM ======== */
    const $ = (s, r = document) => r.querySelector(s);
    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

    /* ======== –ù–∞–≤–∏–≥–∞—Ü–∏—è ======== */
    $$('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        $('#tab-focus').style.display = tab === 'focus' ? '' : 'none';
        $('#tab-plan').style.display = tab === 'plan' ? '' : 'none';
      });
    });

    /* ======== –¢–ê–ô–ú–ï–† ======== */
    function updateTimeDisplay(ms) {
      const sec = Math.floor(ms / 1000);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      $('#timeDisplay').textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }
    function tick() { const elapsed = Date.now() - startTs; updateTimeDisplay(elapsed); }

    $('#startBtn').onclick = () => { if (timerInt) return; startTs = Date.now(); timerInt = setInterval(tick, 250); playPing(); };
    $('#pauseBtn').onclick = () => {
      if (!timerInt) return;
      clearInterval(timerInt); timerInt = null;
      const elapsedMs = Date.now() - startTs;
      const minutes = Math.max(0, Math.round(elapsedMs / 60000));
      const ds = todayStr();
      state.minutesByDate[ds] = (state.minutesByDate[ds] || 0) + minutes;
      state.sessionsDone += 1;
      startTs = null; updateTimeDisplay(0);
      save(); refreshFocus();
    };

    $('#resetBtn').onclick = () => { clearInterval(timerInt); timerInt = null; startTs = null; updateTimeDisplay(0); };

    /* ‚Äî‚Äî –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤–∏–¥–µ–æ: –¥–æ–±–∞–≤–∏—Ç—å +1 –∏ –∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Äî‚Äî */
    $('#finishVideoBtn').onclick = () => {
      const ds = todayStr();
      let minutes = 0;
      if (startTs) {
        const elapsedMs = Date.now() - startTs;
        minutes = Math.max(0, Math.round(elapsedMs / 60000));
        // –¥–æ–±–∞–≤–∏–º —ç—Ç–æ –≤—Ä–µ–º—è –∏ –≤ –æ–±—â–∏–π —Å—á—ë—Ç—á–∏–∫
        state.minutesByDate[ds] = (state.minutesByDate[ds] || 0) + minutes;
      }
      // –∑–∞–ø–∏—à–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ
      if (!state.videoDurationsByDate[ds]) state.videoDurationsByDate[ds] = [];
      state.videoDurationsByDate[ds].push(minutes);
      // +1 –≤–∏–¥–µ–æ
      state.videosByDate[ds] = (state.videosByDate[ds] || 0) + 1;

      // –∞–≤—Ç–æ: –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ —Å –Ω—É–ª—è
      startTs = Date.now();
      if (!timerInt) timerInt = setInterval(tick, 250);
      updateTimeDisplay(0);

      save();
      if (state.autoAdapt) rebalancePlanDynamic(); // –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞
      refreshAll();
      celebrateIfGoal();
      playDong();
    };

    /* ======== –ü–ª—é—Å/–º–∏–Ω—É—Å –≤–∏–¥–µ–æ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏ ======== */
    $('#plus1').onclick = () => { adjustVideosToday(1); };
    $('#minus1').onclick = () => { adjustVideosToday(-1); };
    function adjustVideosToday(delta) {
      const ds = todayStr();
      state.videosByDate[ds] = Math.max(0, (state.videosByDate[ds] || 0) + delta);
      save();
      if (state.autoAdapt) rebalancePlanDynamic();
      refreshAll();
      celebrateIfGoal();
    }

    function celebrateIfGoal() {
      const ds = todayStr();
      const goal = dayPlan(ds);
      const done = state.videosByDate[ds] || 0;
      if (goal > 0 && done >= goal) fireConfetti();
    }

    /* ======== –ü–õ–ê–ù ======== */
    function ensurePlanFilled() {
      const dates = ymToDates(state.periodYM);
      dates.forEach(d => { if (state.planByDate[d] == null) state.planByDate[d] = state.dailyGoal; });
    }

    /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∞: –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ–ª—å–∫–æ "—Å–µ–≥–æ–¥–Ω—è –∏ –≤–ø–µ—Ä—ë–¥" */
    function rebalancePlanDynamic() {
      ensurePlanFilled();
      const dates = ymToDates(state.periodYM);
      const today = todayStr();
      // –†–∞–∑–¥–µ–ª–∏–º –Ω–∞ –ø—Ä–æ—à–µ–¥—à–∏–µ –∏ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–µ–≥–æ–¥–Ω—è
      const past = dates.filter(d => d < today);
      const rest = dates.filter(d => d >= today);

      // –ü–ª–∞–Ω –≤ –ø—Ä–æ—à–ª–æ–º –Ω–µ —Ç—Ä–æ–≥–∞–µ–º, –Ω–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —á—Ç–æ –ø–ª–∞–Ω ‚â• —Ñ–∞–∫—Ç
      past.forEach(d => { state.planByDate[d] = Math.max(state.planByDate[d] || 0, state.videosByDate[d] || 0); });

      // –°—á–∏—Ç–∞–µ–º, —Å–∫–æ–ª—å–∫–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –¥–æ —Å–µ–≥–æ–¥–Ω—è
      const doneSoFar = dates.filter(d => d < today).reduce((s, d) => s + (state.videosByDate[d] || 0), 0);
      const target = Math.max(270, state.targetTotal || 270);

      // –°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–æ–±—Ä–∞—Ç—å –¥–æ —Ü–µ–ª–∏
      let remainingNeed = Math.max(0, target - doneSoFar);

      if (rest.length === 0) {
        save(); return;
      }

      // –ë–∞–∑–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî –º–∏–Ω–∏–º—É–º –±–∞–∑–æ–≤—ã–π –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞–Ω
      const base = Math.max(0, state.dailyGoal || 0);
      const baseSum = base * rest.length;

      // –ï—Å–ª–∏ –¥–æ —Ü–µ–ª–∏ –Ω—É–∂–Ω–æ –º–µ–Ω—å—à–µ, —á–µ–º –±–∞–∑–æ–≤–∞—è —Å—É–º–º–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º –≤–µ–∑–¥–µ –±–∞–∑—É,
      // —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–π–¥–µ–º > —Ü–µ–ª–∏ (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ).
      // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º "–ø–µ—Ä–µ–≥—Ä—É–∑" —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ –ø–æ–≤–µ—Ä—Ö –±–∞–∑—ã.
      let extra = 0;
      if (remainingNeed > baseSum) {
        extra = remainingNeed - baseSum;
      }

      const perExtra = Math.floor(extra / rest.length);
      const remExtra = extra % rest.length;

      rest.forEach((d, i) => {
        const done = state.videosByDate[d] || 0;
        let plan = base + perExtra + (i < remExtra ? 1 : 0);
        // –ø–ª–∞–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω–æ–≥–æ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
        plan = Math.max(plan, done);
        state.planByDate[d] = plan;
      });

      save();
    }

    function dayPlan(ds) { return Math.max(0, parseInt(state.planByDate[ds] ?? state.dailyGoal, 10)); }

    /* –ê–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å (—Ä—É—á–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –ü–ª–∞–Ω) */
    $('#autoDistribute').onclick = () => {
      rebalancePlanDynamic(); refreshAll();
    };
    $('#recalcNow').onclick = () => {
      rebalancePlanDynamic(); refreshAll();
    };

    /* ======== –¢–∞–±–ª–∏—Ü–∞ ======== */
    function buildTable() {
      const tbody = $('#planTable tbody'); tbody.innerHTML = '';
      const dates = ymToDates(state.periodYM);
      $('#periodRange').textContent = `${dates[0]} ‚Äì ${dates[dates.length - 1]}`;
      $('#periodLabel').textContent = humanYM(state.periodYM);
      $('#goalInline').textContent = String(Math.max(270, state.targetTotal || 270));

      let sumPlan = 0, sumDone = 0;
      dates.forEach((ds, i) => {
        const d = new Date(ds);
        const plan = dayPlan(ds);
        const done = Math.max(0, parseInt(state.videosByDate[ds] || 0, 10) || 0);
        const left = Math.max(0, plan - done);
        sumPlan += plan; sumDone += done;

        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${ds}</td>
      <td>${RU_DAYS_FULL[d.getDay()]}</td>
      <td class="right"><input data-type="plan" data-date="${ds}" type="number" min="0" step="1" value="${plan}" style="width:90px"/></td>
      <td class="right"><input data-type="done" data-date="${ds}" type="number" min="0" step="1" value="${done}" style="width:90px"/></td>
      <td class="right">${left}</td>
      <td class="status">${statusBadge(plan, done)}</td>
    `;
        tbody.appendChild(tr);
      });

      const target = Math.max(270, state.targetTotal || 270);
      const leftToGoal = Math.max(0, target - sumDone);

      $('#tPlan').textContent = sumPlan;
      $('#tDone').textContent = sumDone;
      $('#tLeft').textContent = leftToGoal;
      $('#tStatus').innerHTML = progressStatus(sumDone, target);

      // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
      $$('#planTable input').forEach(inp => {
        inp.addEventListener('input', () => {
          const ds = inp.dataset.date;
          const val = Math.max(0, parseInt(inp.value || 0, 10));
          if (inp.dataset.type === 'plan') { state.planByDate[ds] = val; }
          else { state.videosByDate[ds] = val; }
          save();
          if (state.autoAdapt && inp.dataset.type === 'done') rebalancePlanDynamic();
          refreshAll();
        });
      });
    }

    function statusBadge(plan, done) {
      if (plan === 0 && done === 0) return `<span class="muted">‚Äî</span>`;
      if (done === 0) return `<span class="bad">–°—Ç–∞—Ä—Ç—É–π</span>`;
      if (done < plan) return `<span class="warnc">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>`;
      if (done === plan) return `<span class="ok">–ì–æ—Ç–æ–≤–æ</span>`;
      if (done > plan) return `<span class="ok">–°–≤–µ—Ä—Ö –ø–ª–∞–Ω–∞</span>`;
      return `<span class="muted">‚Äî</span>`;
    }
    function progressStatus(done, goal) {
      if (goal === 0) return '<span class="muted">‚Äî</span>';
      const pct = Math.round(done / goal * 100);
      let cls = 'warnc', label = '–í –ø—É—Ç–∏';
      if (pct > 100) { cls = 'ok'; label = '–°–≤–µ—Ä—Ö —Ü–µ–ª–∏'; }
      else if (pct >= 100) { cls = 'ok'; label = '–¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞'; }
      else if (pct >= 75) { cls = 'ok'; label = '–û—Ç–ª–∏—á–Ω–æ'; }
      else if (pct < 25) { cls = 'bad'; label = '–ù–∞—á–∏–Ω–∞–π'; }
      return `<span class="${cls}">${label} ‚Ä¢ ${pct}%</span>`;
    }
    function humanYM(ym) {
      const [y, m] = ym.split('-').map(Number);
      const names = ['—è–Ω–≤–∞—Ä—å', '—Ñ–µ–≤—Ä–∞–ª—å', '–º–∞—Ä—Ç', '–∞–ø—Ä–µ–ª—å', '–º–∞–π', '–∏—é–Ω—å', '–∏—é–ª—å', '–∞–≤–≥—É—Å—Ç', '—Å–µ–Ω—Ç—è–±—Ä—å', '–æ–∫—Ç—è–±—Ä—å', '–Ω–æ—è–±—Ä—å', '–¥–µ–∫–∞–±—Ä—å'];
      return `${names[m - 1]} ${y}`;
    }

    /* ======== –ú–ï–¢–†–ò–ö–ò –¢–ê–ô–ú–ï–†–ê / –≠–§–§–ï–ö–¢–ò–í–ù–û–°–¢–¨ ======== */
    function sum(arr) { return arr.reduce((a, b) => a + b, 0); }
    function metricsToday() {
      const ds = todayStr();
      const vids = state.videosByDate[ds] || 0;
      const minDay = state.minutesByDate[ds] || 0;
      const arr = state.videoDurationsByDate[ds] || [];
      const videoMin = sum(arr);
      const last = arr.length ? arr[arr.length - 1] : null;
      const avg = arr.length ? Math.round(videoMin / arr.length) : null;
      const best = arr.length ? Math.min(...arr) : null;
      const worst = arr.length ? Math.max(...arr) : null;
      const vph = (minDay > 0) ? (vids / (minDay / 60)) : null; // –≤–∏–¥–µ–æ –≤ —á–∞—Å
      const mpv = (vids > 0) ? Math.round((videoMin / vids) * 10) / 10 : null; // –º–∏–Ω/–≤–∏–¥–µ–æ –ø–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –≤–∏–¥–µ–æ–º–∏–Ω—É—Ç–∞–º
      return { vids, minDay, arr, videoMin, last, avg, best, worst, vph, mpv };
    }

    /* ======== –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ ======== */
    function fireConfetti(duration = 1600, count = 120) {
      const canvas = $('#confetti'); const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const { innerWidth: w, innerHeight: h } = window;
      canvas.width = w * dpr; canvas.height = h * dpr; ctx.scale(dpr, dpr);
      const parts = Array.from({ length: count }).map(() => ({
        x: Math.random() * w, y: -20, r: 2 + Math.random() * 4, vx: (Math.random() - .5) * 2, vy: 2 + Math.random() * 3, rot: Math.random() * Math.PI
      }));
      let start = null; canvas.style.opacity = 1;
      function step(ts) {
        start ??= ts; const t = ts - start;
        ctx.clearRect(0, 0, w, h);
        parts.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.03; p.rot += 0.1;
          ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
          ctx.fillStyle = `hsl(${(p.x + p.y) % 360},90%,60%)`;
          ctx.fillRect(-p.r, -p.r, p.r * 2, p.r * 2);
          ctx.restore();
        });
        if (t < duration) requestAnimationFrame(step); else canvas.style.opacity = 0;
      }
      requestAnimationFrame(step);
    }

    /* ======== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======== */
    $('#applySettings').onclick = () => {
      const ym = $('#monthInput').value || state.periodYM;
      state.periodYM = ym;
      const dg = parseInt($('#dailyGoalInput').value || state.dailyGoal, 10);
      state.dailyGoal = isFinite(dg) ? Math.max(0, dg) : state.dailyGoal;
      const tt = parseInt($('#targetTotalInput').value || state.targetTotal, 10);
      state.targetTotal = isFinite(tt) ? Math.max(270, tt) : Math.max(270, state.targetTotal || 270);
      const tv = parseInt($('#targetVideoMinInput').value || state.targetVideoMin, 10);
      state.targetVideoMin = isFinite(tv) ? Math.max(1, tv) : state.targetVideoMin;
      state.autoAdapt = $('#autoAdaptInput').checked;
      ensurePlanFilled();
      if (state.autoAdapt) rebalancePlanDynamic();
      save(); refreshAll();
    };

    $('#resetAll').onclick = () => {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) {
        localStorage.removeItem(KEY_V2); Object.assign(state, defaultState());
        save(); refreshAll();
      }
    };
    $('#prevMonth').onclick = () => { state.periodYM = addMonthsYM(state.periodYM, -1); ensurePlanFilled(); if (state.autoAdapt) rebalancePlanDynamic(); save(); refreshAll(); };
    $('#nextMonth').onclick = () => { state.periodYM = addMonthsYM(state.periodYM, 1); ensurePlanFilled(); if (state.autoAdapt) rebalancePlanDynamic(); save(); refreshAll(); };

    /* ======== –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç ======== */
    $('#exportBtn').onclick = () => {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'video-1-28-dynamic-plan.json'; a.click();
      URL.revokeObjectURL(url);
    };
    $('#importBtn').onclick = () => $('#importFile').click();
    $('#importFile').addEventListener('change', e => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          if (!obj || typeof obj !== 'object') throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
          localStorage.setItem(KEY_V2, JSON.stringify(obj));
          Object.assign(state, obj);
          refreshAll();
          alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ');
        } catch (err) { alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message); }
      };
      reader.readAsText(file);
    });

    /* ======== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI ======== */
    function refreshFocus() {
      const ds = todayStr();
      const done = state.videosByDate[ds] || 0;
      const minDay = state.minutesByDate[ds] || 0;
      $('#videosToday').textContent = done;
      $('#videosTodayInline').textContent = done;
      $('#minutesToday').textContent = minDay;
      $('#sessionsDone').textContent = state.sessionsDone;

      const goalToday = dayPlan(ds);
      $('#dailyGoalLabel').textContent = goalToday;
      const pct = goalToday > 0 ? Math.min(100, Math.round((done / goalToday) * 100)) : (done > 0 ? 100 : 0);
      $('#dayBar').style.width = pct + '%';

      // –°—Ç–∏–∫
      $('#streakBadge').textContent = `üî• –°—Ç–∏–∫: ${calcStreak()}`;

      // –ú–µ—Ç—Ä–∏–∫–∏ —Ç–∞–π–º–µ—Ä–∞
      const m = metricsToday();
      $('#lastVideoMin').textContent = m.last == null ? '‚Äî' : m.last;
      $('#avgVideoMin').textContent = m.avg == null ? '‚Äî' : m.avg;
      $('#bestWorst').textContent = m.best == null ? '‚Äî' : `${m.best}/${m.worst}`;
      $('#videoMinutesToday').textContent = m.videoMin || 0;
      const vph = m.vph == null ? '‚Äî' : (Math.round(m.vph * 10) / 10);
      const mpv = m.mpv == null ? '‚Äî' : m.mpv;
      $('#efficiency').textContent = mpv === '‚Äî' ? '‚Äî' : `${mpv} –º–∏–Ω ‚Ä¢ ${vph} vph`;

      // –¶–µ–ª–µ–≤–æ–µ –≤—Ä–µ–º—è –Ω–∞ –≤–∏–¥–µ–æ –∏ –¥–µ–ª—å—Ç–∞
      $('#targetVideoMinLabel').textContent = state.targetVideoMin || 10;
      if (m.mpv && state.targetVideoMin) {
        const delta = Math.round((m.mpv - state.targetVideoMin) * 10) / 10;
        const arrow = delta > 0 ? '‚Üë' : '‚Üì';
        const txt = delta === 0 ? '= —Ü–µ–ª—å' : `${arrow} ${Math.abs(delta)} –º–∏–Ω`;
        $('#deltaLabel').textContent = txt;
      } else {
        $('#deltaLabel').textContent = '‚Äî';
      }

      // –°–≤–æ–¥–∫–∞ –ø–µ—Ä–∏–æ–¥–∞
      const dates = ymToDates(state.periodYM);
      let sumDone = 0; dates.forEach(d => sumDone += (state.videosByDate[d] || 0));
      const target = Math.max(270, state.targetTotal || 270);
      const left = Math.max(0, target - sumDone);
      $('#planTotal').textContent = target;
      $('#doneTotal').textContent = sumDone;
      $('#leftTotal').textContent = left;
      const progress = target > 0 ? Math.round(sumDone / target * 100) : 0;
      $('#progressPct').textContent = progress + '%';
    }

    function refreshSettings() {
      $('#monthInput').value = state.periodYM;
      $('#dailyGoalInput').value = state.dailyGoal;
      $('#targetTotalInput').value = state.targetTotal;
      $('#targetVideoMinInput').value = state.targetVideoMin;
      $('#autoAdaptInput').checked = !!state.autoAdapt;
    }
    function refreshTable() { buildTable(); }
    function refreshAll() { ensurePlanFilled(); if (state.autoAdapt) rebalancePlanDynamic(); refreshSettings(); refreshFocus(); refreshTable(); updateChart(); }

    /* ======== –ì—Ä–∞—Ñ–∏–∫–∏ (Chart.js) ======== */
    let myChart = null;
    function updateChart() {
      const ctx = $('#prodChart');
      if (!ctx) return;
      const days = Object.keys(state.minutesByDate).sort();
      // –≤–æ–∑—å–º–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 14 –¥–Ω–µ–π –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –∏–ª–∏ –≤—Å–µ –µ—Å–ª–∏ –º–∞–ª–æ
      const labels = days.slice(-14);
      const dataMins = labels.map(d => state.minutesByDate[d] || 0);
      const dataVids = labels.map(d => state.videosByDate[d] || 0);

      if (myChart) {
        myChart.data.labels = labels;
        myChart.data.datasets[0].data = dataMins;
        myChart.data.datasets[1].data = dataVids;
        myChart.update();
      } else {
        myChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              { label: '–ú–∏–Ω—É—Ç—ã', data: dataMins, yAxisID: 'y', backgroundColor: 'rgba(108, 123, 255, 0.5)', borderColor: '#6c7bff', borderWidth: 1 },
              { label: '–í–∏–¥–µ–æ', data: dataVids, yAxisID: 'y1', type: 'line', borderColor: '#4ce0b3', tension: 0.3, pointBackgroundColor: '#4ce0b3' }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#b8bef5' } } },
            scales: {
              x: { ticks: { color: '#8d93b5' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y: { type: 'linear', position: 'left', ticks: { color: '#8d93b5' }, grid: { color: 'rgba(255,255,255,0.05)' } },
              y1: { type: 'linear', position: 'right', ticks: { color: '#4ce0b3' }, grid: { drawOnChartArea: false } }
            }
          }
        });
      }
    }

    /* ======== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ======== */
    function calcStreak() {
      // –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π —Å—Ç—Ä–∏–∫: –ø–æ–¥—Ä—è–¥ –¥–Ω–∏ —Å done>0
      let streak = 0;
      let d = new Date(); d.setHours(0, 0, 0, 0);
      for (let i = 0; i < 90; i++) {
        const ds = d.toISOString().slice(0, 10);
        const done = state.videosByDate[ds] || 0;
        if (done > 0) { streak++; } else { break; }
        d.setDate(d.getDate() - 1);
      }
      return streak;
    }


    /* ======== –ó–≤—É–∫–∏ ======== */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playPing() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
      osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
    function playDong() {
      if (audioCtx.state === 'suspended') audioCtx.resume();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'triangle'; osc.frequency.setValueAtTime(300, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.4);
      gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
      osc.start(); osc.stop(audioCtx.currentTime + 0.4);
    }

    /* ======== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======== */
    function init() {
      if (location.hash === '#plan') { $$('.tab-btn')[1].click(); }
      refreshAll();
    }
    init();
  </script>
</body>

</html>